library(shiny)
library(rgdal)
library(DT)
library(dygraphs)
library(xts)
library(leaflet)
library(geojsonio)

data <- read.csv("data/featuresApp.csv")
#map <- readOGR("data/Boater_Joined_2/Boater_Joined_2.shp")
map <- geojsonio::geojson_read("data/map.geojson", what = "sp")
mapNotClean <- geojsonio::geojson_read("data/NotClean.geojson", what = "sp")
mapFreshOutside <- geojsonio::geojson_read("data/FreshOutside.geojson", what = "sp")
# ui object

ui <- fluidPage(
  titlePanel(p("Mapping responses from registered boat owners in Alaska", style="color:#3474A7")),
  sidebarLayout(
    sidebarPanel(
      selectInput(inputId = "variableselected", label = "Select numeric variable to show in color",
                  list(`Trip frequency`= "freqPre",
                       `Total anual km`="totalKmPre",
                       `Route length in km`="km",
                       `Personal income`="Income",
                       `Average number of passengers`="pax",
                       `Boat owner age`="age",
                       `Annual operating cost`="YrCostPre")),
    
      selectInput(inputId = "mapselected", label = "Select boaters who were boating outside Alaska",
                  list(`mapNotClean`="Boats not always clean-drain-dried",
                       `mapFreshOutside`="Boats first used out-of-state"))),
    
    mainPanel(
      leafletOutput(outputId = "map")  #Insert, here if other parts become active
    )
  )
)

# server()
server <- function(input, output, session) {
  filteredData <- reactive({
    subset(data, data$freshOutside == input$variableselected )
  })
 
  output$map <- renderLeaflet({
    
    leaflet() %>% 
      addTiles() %>% 
      addProviderTiles("Esri")
    })
    
  leafletProxy("map", data = selectedstuff()) %>%
    clearShapes() %>%
    addPolylines(
      stroke = TRUE, 
      color = ~pal(variableplot), #"green"
      weight = 2,
      opacity = 1.0, 
      fill = FALSE,
     # dashArray = "3",
     # fillColor =  ~pal(variableplot),
      fillOpacity = 0.2, 
      smoothFactor = 3,
      noClip=TRUE,
      label = labels) %>%
    addLegend(pal = pal, values = ~variableplot, opacity = 0.7, title = NULL)
    
    
    
    # Add data to map
    map@data <- subset(data, data$freshOutside == input$selectOutside )

     # Create variableplot
    map$variableplot <- as.numeric(map@data[, input$variableselected]) # ADD this to create variableplot
    
    # Create leaflet
    pal <- colorBin("YlOrRd", domain = map$variableplot, bins =5,  alpha = FALSE, na.color = "black", reverse=T) # CHANGE map$cases by map$variableplot
    
    labels <- sprintf("%s: %g", map$responseID, map$variableplot) %>% lapply(htmltools::HTML) # CHANGE map$cases by map$variableplot
    
    l <- 
  })
}

# shinyApp()
shinyApp(ui = ui, server = server)